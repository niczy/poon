name: presubmit 

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install protoc
      uses: arduino/setup-protoc@v3
      with:
        version: '25.x'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: CI Setup
      run: make ci-setup
    
    - name: CI Build
      run: make ci-build
    
    - name: CI Test
      run: make ci-test
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  test-component:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [poon-proto, poon-server, poon-git, poon-cli, poon-tests, poon-web]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    
    - name: Set up Node.js
      if: matrix.component == 'poon-proto' || matrix.component == 'poon-web'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install protoc
      if: matrix.component == 'poon-proto' || matrix.component == 'poon-server' || matrix.component == 'poon-git' || matrix.component == 'poon-cli'
      uses: arduino/setup-protoc@v3
      with:
        version: '25.x'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: CI Setup
      run: make ci-setup
    
    - name: Test Component
      run: make ci-test-component COMPONENT=${{ matrix.component }}